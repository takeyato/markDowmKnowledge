<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Markdown記事編集</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css">
  <link rel="stylesheet" href="https://uicdn.toast.com/tui-image-editor/latest/tui-image-editor.css">
  <style>
    #editor { height: 500px; }
    #imageEditorModal .modal-body { padding: 0; }
    #image-editor { height: 600px; }
    .tui-image-editor-header-logo { display: none; }
  </style>
</head>
<body class="bg-light">

<div class="container py-4">
  <h2 class="mb-4">📝 記事を作成・編集</h2>

  <!-- タイトル -->
  <div class="mb-3">
    <label for="title" class="form-label">タイトル</label>
    <input type="text" class="form-control" id="title" placeholder="例：Linux GUIが起動しないときの対処法">
  </div>

  <!-- タグ -->
  <div class="mb-3">
    <label for="tags" class="form-label">タグ（カンマ区切り）</label>
    <input type="text" class="form-control" id="tags" placeholder="例：Linux, GUI, トラブルシューティング">
  </div>

  <!-- カテゴリ -->
  <div class="mb-3">
    <label for="category" class="form-label">カテゴリ</label>
    <select class="form-select" id="category">
      <option selected disabled>選択してください</option>
      <option value="tech">技術</option>
      <option value="manual">業務マニュアル</option>
      <option value="faq">よくある質問</option>
    </select>
  </div>

  <!-- ボタン群 -->
  <div class="d-flex justify-content-end gap-2 mb-3">
    <button class="btn btn-secondary">下書き保存</button>
    <button class="btn btn-outline-primary">プレビュー</button>
    <button class="btn btn-success" id="publishBtn">公開する</button>
  </div>

  <!-- Toast UI Editor -->
  <div id="editor"></div>
</div>

<!-- Bootstrap モーダルで Image Editor を表示 -->
<div class="modal fade" id="imageEditorModal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body">
        <div id="image-editor"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
        <button class="btn btn-primary" id="confirm-edit">編集完了して挿入</button>
      </div>
    </div>
  </div>
</div>

<!-- JSライブラリ -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>
<script src="https://uicdn.toast.com/tui-image-editor/latest/tui-image-editor.min.js"></script>

<script>
  let editor, imageEditor, imageCallback;

  // Toast UI Editor 初期化
  editor = new toastui.Editor({
    el: document.querySelector('#editor'),
    height: '500px',
    initialEditType: 'markdown',
    previewStyle: 'vertical',
    placeholder: 'ここにMarkdownを入力してください...',
    hooks: {
      addImageBlobHook: async (blob, callback) => {
        imageCallback = callback;
        openImageEditor(blob);
        return false;
      }
    }
  });

  // Image Editor をモーダルで開く
  function openImageEditor(blob) {
    const modal = new bootstrap.Modal(document.getElementById('imageEditorModal'));
    modal.show();

    imageEditor = new tui.ImageEditor(document.querySelector('#image-editor'), {
      includeUI: {
        loadImage: { path: URL.createObjectURL(blob), name: 'uploaded' },
        theme: {
          'common.backgroundColor': '#fff',
          'menu.iconSize.width': '20px',
          'menu.iconSize.height': '20px',
          'submenu.backgroundColor': '#f8f9fa',
          'submenu.normalLabel.color': '#333',
          'submenu.activeLabel.color': '#007bff'
        },
        menu: ['crop', 'rotate'],
        initMenu: 'crop',
        uiSize: { width: '100%', height: '600px' },
        menuBarPosition: 'bottom'
      },
      cssMaxWidth: 700,
      cssMaxHeight: 500
    });
  }

  // 編集完了 → 軽量化 → 挿入
  document.getElementById('confirm-edit').addEventListener('click', async () => {
    const dataUrl = imageEditor.toDataURL();
    const compressed = await compressImage(dataUrl, 0.7);
    imageCallback(compressed, 'edited-image.jpg');
    bootstrap.Modal.getInstance(document.getElementById('imageEditorModal')).hide();
    imageEditor.destroy();
  });

  // 軽量化処理
  function compressImage(dataUrl, quality = 0.7) {
    return new Promise(resolve => {
      const img = new Image();
      img.src = dataUrl;
      img.onload = () => {
        const canvas = document.createElement('canvas');
        canvas.width = img.width;
        canvas.height = img.height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0);
        const compressed = canvas.toDataURL('image/jpeg', quality);
        resolve(compressed);
      };
    });
  }

  // 公開ボタン例
  document.getElementById('publishBtn').addEventListener('click', () => {
    const markdown = editor.getMarkdown();
    console.log('保存するMarkdown:', markdown);
    // Ajaxで送信など
  });
</script>

</body>
</html>
