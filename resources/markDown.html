<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Markdownè¨˜äº‹ç·¨é›†</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css">
  <link rel="stylesheet" href="https://uicdn.toast.com/tui-image-editor/latest/tui-image-editor.css">
  <style>
    #editor { height: 500px; }
    #imageEditorModal .modal-body { padding: 0; }
    #image-editor { height: 600px; }
    .tui-image-editor-header-logo { display: none; }
  </style>
</head>
<body class="bg-light">

<div class="container py-4">
  <h2 class="mb-4">ğŸ“ è¨˜äº‹ã‚’ä½œæˆãƒ»ç·¨é›†</h2>

  <!-- ã‚¿ã‚¤ãƒˆãƒ« -->
  <div class="mb-3">
    <label for="title" class="form-label">ã‚¿ã‚¤ãƒˆãƒ«</label>
    <input type="text" class="form-control" id="title" placeholder="ä¾‹ï¼šLinux GUIãŒèµ·å‹•ã—ãªã„ã¨ãã®å¯¾å‡¦æ³•">
  </div>

  <!-- ã‚¿ã‚° -->
  <div class="mb-3">
    <label for="tags" class="form-label">ã‚¿ã‚°ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰</label>
    <input type="text" class="form-control" id="tags" placeholder="ä¾‹ï¼šLinux, GUI, ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°">
  </div>

  <!-- ã‚«ãƒ†ã‚´ãƒª -->
  <div class="mb-3">
    <label for="category" class="form-label">ã‚«ãƒ†ã‚´ãƒª</label>
    <select class="form-select" id="category">
      <option selected disabled>é¸æŠã—ã¦ãã ã•ã„</option>
      <option value="tech">æŠ€è¡“</option>
      <option value="manual">æ¥­å‹™ãƒãƒ‹ãƒ¥ã‚¢ãƒ«</option>
      <option value="faq">ã‚ˆãã‚ã‚‹è³ªå•</option>
    </select>
  </div>

  <!-- ãƒœã‚¿ãƒ³ç¾¤ -->
  <div class="d-flex justify-content-end gap-2 mb-3">
    <button class="btn btn-secondary">ä¸‹æ›¸ãä¿å­˜</button>
    <button class="btn btn-outline-primary">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>
    <button class="btn btn-success" id="publishBtn">å…¬é–‹ã™ã‚‹</button>
  </div>

  <!-- Toast UI Editor -->
  <div id="editor"></div>
</div>

<!-- Bootstrap ãƒ¢ãƒ¼ãƒ€ãƒ«ã§ Image Editor ã‚’è¡¨ç¤º -->
<div class="modal fade" id="imageEditorModal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body">
        <div id="image-editor"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn btn-primary" id="confirm-edit">ç·¨é›†å®Œäº†ã—ã¦æŒ¿å…¥</button>
      </div>
    </div>
  </div>
</div>

<!-- JSãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>
<script src="https://uicdn.toast.com/tui-image-editor/latest/tui-image-editor.min.js"></script>

<script>
  let editor, imageEditor, imageCallback;

  // Toast UI Editor åˆæœŸåŒ–
  editor = new toastui.Editor({
    el: document.querySelector('#editor'),
    height: '500px',
    initialEditType: 'markdown',
    previewStyle: 'vertical',
    placeholder: 'ã“ã“ã«Markdownã‚’å…¥åŠ›ã—ã¦ãã ã•ã„...',
    hooks: {
      addImageBlobHook: async (blob, callback) => {
        imageCallback = callback;
        openImageEditor(blob);
        return false;
      }
    }
  });

  // Image Editor ã‚’ãƒ¢ãƒ¼ãƒ€ãƒ«ã§é–‹ã
  function openImageEditor(blob) {
    const modal = new bootstrap.Modal(document.getElementById('imageEditorModal'));
    modal.show();

    imageEditor = new tui.ImageEditor(document.querySelector('#image-editor'), {
      includeUI: {
        loadImage: { path: URL.createObjectURL(blob), name: 'uploaded' },
        theme: {
          'common.backgroundColor': '#fff',
          'menu.iconSize.width': '20px',
          'menu.iconSize.height': '20px',
          'submenu.backgroundColor': '#f8f9fa',
          'submenu.normalLabel.color': '#333',
          'submenu.activeLabel.color': '#007bff'
        },
        menu: ['crop', 'rotate'],
        initMenu: 'crop',
        uiSize: { width: '100%', height: '600px' },
        menuBarPosition: 'bottom'
      },
      cssMaxWidth: 700,
      cssMaxHeight: 500
    });
  }

  // ç·¨é›†å®Œäº† â†’ è»½é‡åŒ– â†’ æŒ¿å…¥
  document.getElementById('confirm-edit').addEventListener('click', async () => {
    const dataUrl = imageEditor.toDataURL();
    const compressed = await compressImage(dataUrl, 0.7);
    imageCallback(compressed, 'edited-image.jpg');
    bootstrap.Modal.getInstance(document.getElementById('imageEditorModal')).hide();
    imageEditor.destroy();
  });

  // è»½é‡åŒ–å‡¦ç†
  function compressImage(dataUrl, quality = 0.7) {
    return new Promise(resolve => {
      const img = new Image();
      img.src = dataUrl;
      img.onload = () => {
        const canvas = document.createElement('canvas');
        canvas.width = img.width;
        canvas.height = img.height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0);
        const compressed = canvas.toDataURL('image/jpeg', quality);
        resolve(compressed);
      };
    });
  }

  // å…¬é–‹ãƒœã‚¿ãƒ³ä¾‹
  document.getElementById('publishBtn').addEventListener('click', () => {
    const markdown = editor.getMarkdown();
    console.log('ä¿å­˜ã™ã‚‹Markdown:', markdown);
    // Ajaxã§é€ä¿¡ãªã©
  });
</script>

</body>
</html>
